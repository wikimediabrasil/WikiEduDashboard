- content_for :javascripts do
  = javascript_include_tag '/assets/javascripts/jquery.min.js'
  = hot_javascript_tag("campaigns")

- content_for :before_title, t('courses.campaign_articles', title: @campaign.title) + ' â€” '

#react_root{data: {slug: @campaign.slug}}

.container
  %section.overview.container

.container
  %section#campaign-articles
    .section-header
      %h3
        = t('courses.campaign_articles', title: @campaign.title)
      .sort-select
        %select.sorts{rel: 'campaign-articles'}
          %option{rel: 'asc', value: 'title'}
            = t("articles.title")
          %option{rel: 'desc', value: 'char_added'}
            = t("metrics.char_added")
          %option{rel: 'desc', value: 'references'}
            = t("metrics.references_count")
          %option{rel: 'desc', value: 'views'}
            = t("metrics.view")
          %option{rel: 'asc', value: 'lang_project'}
            = t("articles.wiki")
          %option{rel: 'asc', value: 'course_title'}
            = t("#{@presenter.course_string_prefix}.courses")
      = form_tag(articles_campaign_path(@campaign.slug), method: :get, class: 'course-filters campaign-articles-search-form') do
        = hidden_field_tag :sort, params[:sort]        
        = hidden_field_tag :direction, params[:direction]
        .form-fields
          .form-row
            = text_field_tag :title, params[:title], placeholder: t('form_search.search') + ' ' + t('articles.article_title'), class: 'form-control input-sm input-full-width'
          .form-row
            %button.button.border.small.advanced-search-toggle-button#toggle_advanced_search{type: 'button'}
              = t('form_search.advanced_search')
        #advanced_search_fields.hidden
          .form-row.relative
            = select_tag 'school[]', options_for_select(@presenter.school_options, params[:school]), multiple: true, id: 'school_select', class: 'school-select-wrapper'
            :javascript
              document.addEventListener('DOMContentLoaded', () => {
                if (typeof TomSelect !== 'undefined') {
                  new TomSelect('#school_select', {
                    plugins: ['remove_button'],
                    placeholder: "#{t('courses.school')}...",
                    allowEmptyOption: true
                  });
                }
              });
          .form-row.advanced-search-grid-small
            %label{for: 'char_added_from'}= t("metrics.char_added")
            .input-group.flex-input-group
              = number_field_tag :char_added_from, params[:char_added_from], class: 'form-control input-sm', min: 0, placeholder: 'Min'
              %span -
              = number_field_tag :char_added_to, params[:char_added_to], class: 'form-control input-sm', min: 0, placeholder: 'Max'
          .form-row.advanced-search-grid-small
            %label{for: 'references_count_from'}= t("metrics.references_count")
            .input-group.flex-input-group
              = number_field_tag :references_count_from, params[:references_count_from], class: 'form-control input-sm', min: 0, placeholder: 'Min'
              %span -
              = number_field_tag :references_count_to, params[:references_count_to], class: 'form-control input-sm', min: 0, placeholder: 'Max'
          .form-row.advanced-search-grid-small
            %label{for: 'view_count_from'}= t("metrics.view")
            .input-group.flex-input-group
              = number_field_tag :view_count_from, params[:view_count_from], class: 'form-control input-sm', min: 0, placeholder: 'Min'
              %span -
              = number_field_tag :view_count_to, params[:view_count_to], class: 'form-control input-sm', min: 0, placeholder: 'Max'
        .form-actions
          = submit_tag t('form_search.search'), class: 'button'
          = link_to t('form_search.clear'), articles_campaign_path(@campaign.slug), class: 'button'
    
    -  result = @presenter.campaign_articles
    -  articles_courses = result[:articles_courses]
    -  courses = result[:courses]
    -  articles = result[:articles]
    :javascript
      window.DISABLE_ARTICLES_LISTJS = true;
      
      document.addEventListener('DOMContentLoaded', function() {
        const headers = document.querySelectorAll('#campaign-articles table th.sortable');
        
        headers.forEach(function(th) {
          th.style.cursor = 'pointer';
          
          th.onclick = function(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            
            const backendColumn = th.getAttribute('data-backend-column');
            const defaultOrder = th.getAttribute('data-default-order') || 'asc';
            
            const urlParams = new URLSearchParams(window.location.search);
            const currentSort = urlParams.get('sort');
            const currentDirection = urlParams.get('direction');
            
            let newDirection = defaultOrder;
            if (currentSort === backendColumn) {
              newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            }
            
            urlParams.set('sort', backendColumn);
            urlParams.set('direction', newDirection);
            urlParams.delete('page');
            
            window.location.href = window.location.pathname + '?' + urlParams.toString();
          };
        });
      });

    %table.table.table--hoverable.table--sortable
      %thead
        %tr
          %th.sort.sortable{'data-default-order' => 'asc', 'data-sort' => 'title', 'data-backend-column' => 'title'}
            = t('articles.title')
            %span.sortable-indicator
          %th.sort.sortable.desc{'data-default-order' => 'desc', 'data-sort' => 'char_added', 'data-backend-column' => 'char_added'}
            .tooltip-trigger
              = t('metrics.char_added')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= t('articles.character_doc')
          %th.sort.sortable{'data-default-order' => 'desc', 'data-sort' => 'references', 'data-backend-column' => 'references'}
            .tooltip-trigger
              = t('metrics.references_count')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= t('metrics.references_doc')
          %th.sort.sortable{'data-default-order' => 'desc', 'data-sort' => 'views', 'data-backend-column' => 'views'}
            .tooltip-trigger
              = t('metrics.view')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= t('articles.view_doc')
          %th.sort.sortable{'data-sort' => 'lang_project'}
            = t('articles.wiki')
            %span.sortable-indicator
          %th.sort.sortable{'data-sort' => 'course_title'}
            = t("#{@presenter.course_string_prefix}.courses")
            %span.sortable-indicator

      %tbody.list
        - if articles_courses.empty?
          %tr.disabled
            %td{:class => "text-center", :colSpan => 7}
              %span= I18n.t('articles.none')
        - else
          - articles_courses.each do |ac|
            - course = courses[ac.course_id]
            - article = articles[ac.article_id]
            - cache ["article_row", ac.article_id, ac.course_id, ac.updated_at, locale] do
              = render 'campaigns/article_row', article:, article_course: ac, course:

    = will_paginate articles_courses, renderer: WillPaginate::LinkRenderer, previous_label: t('articles.previous'), next_label: t('articles.next'), inner_window: 1, outer_window: 1
    .page-entries-info{style: 'text-align: center; color: #666; font-size: 14px; margin-top: 10px;'}
      = t('articles.page_info', current: articles_courses.current_page, total_pages: articles_courses.total_pages, count: articles_courses.length, total: articles_courses.total_entries) 
